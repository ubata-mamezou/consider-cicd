# # Javaアプリケーションのビルド
# ## 前提とする言語など
# * Java21
# * Maven
name: CI/CD Java Application

env:
  APP_NAME: order # アプリケーション名
  APP_VERSION: 0.0.1 # アプリケーションバージョン
  AWS_REGION: ap-northeast-1 # AWSリージョン
  WORK_DIRECTORY: order # 作業ディレクトリ
  DIST_DIRECTORY: target # ビルドリソースの生成されるフォルダー
  JAVA_VERSION: 21 # 使用するJavaのバージョン


on:
  workflow_dispatch: #手動実行
  push:
    branches: 
      - 'develop/**'
    paths: 
      - 'order/**'

jobs:
  # ワークフローの設定ロード
  workflow-config:
    uses: ./.github/workflows/load-config.yaml
    with:
      profile: dev
      config-file-directory: order
  # ビルド
  build:
    needs: workflow-config
    uses: ./.github/workflows/build-java-app.yaml
    with:
      app-name: ${{ needs.workflow-config.outputs.app-name}}
      app-version: ${{ needs.workflow-config.outputs.app-version}}
      work-directory: ${{ needs.workflow-config.outputs.work-directory}}
      dist-directory: ${{ needs.workflow-config.outputs.dist-directory}}
      java-version: ${{ needs.workflow-config.outputs.java-version}}
      test-report-cache-key: ${{ needs.workflow-config.outputs.test-report-cache-key}}
      build-artifacts-cache-key: ${{ needs.workflow-config.outputs.build-artifacts-cache-key}}
      is-publish: true
  # イメージビルド
  build-image:
    needs: 
      - workflow-config
      - build
    uses: ./.github/workflows/build-image.yaml
    with:
      app-name: ${{ needs.workflow-config.outputs.app-name}}
      app-version: ${{ needs.workflow-config.outputs.app-version}}
      work-directory: ${{ needs.workflow-config.outputs.work-directory}}
      dist-directory: ${{ needs.workflow-config.outputs.dist-directory}}
      build-artifacts-cached-key: ${{ needs.workflow-config.outputs.build-artifacts-cache-key}}
      scan-report-cache-key: ${{ needs.workflow-config.outputs.scan-report-cache-key}}
      is-publish: true
  # テストレポートを公開
  publish-test-result:
    needs: 
      - workflow-config
      - build-image
    uses: ./.github/workflows/publish-report.yaml
    with:
      app-name: ${{ needs.workflow-config.outputs.app-name}}
      test-report-cached-key: ${{ needs.workflow-config.outputs.test-report-cache-key}}
      scan-report-cached-key: ${{ needs.workflow-config.outputs.scan-report-cache-key}}
  # デプロイ(デプロイ先：AWS)
  deploy:
    needs:
      - workflow-config 
      - build-image
    uses: ./.github/workflows/deploy-dev-aws.yaml
    # Tips：自身で設定したsecretを別ファイルから参照するには？
    # 別ファイルにしたワークフローはスコープの問題でsecretの参照に失敗します。
    # inheritをつけることで呼び出し先にSecretが引き継がれるので、呼び出し先でも参照することができます。
    secrets: inherit 
    with:
      app-name: ${{ needs.workflow-config.outputs.app-name}}
      app-version: ${{ needs.workflow-config.outputs.app-version}}
      aws-region: ap-northeast-1
      aws-ecr-repository-name: consider-cicd
      ecs-cluster-name: consider-cicd-ecs
      ecs-service-name: consider-cicd-ecs-service_order-service
      ecs-task-name: consider-cicd-ecs-task-order
      env-variables: |
        {"name": "PORT", "value": "8081"}, 
        {"name": "TEST_ENV", "value": "dev"}
